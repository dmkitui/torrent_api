{% extends 'base.html' %}
{% macro dir_info(info) %}
    <div class="dir-metadata">Downloaded <span class="dir-info-text">{{ moment(timestamp=info[9]|timestamp_to_datetime).fromNow() }}</span></div>
{% endmacro %}

{% macro folderSize(sub_dir, current_size) %}
    {% set dir_size = namespace(size=current_size) %}
    {% if sub_dir|length > 0 %}
        {% for file in sub_dir %}
            {% if file['type'] == 'file' %}
                {% set dir_size.size = dir_size.size + file['size'] %}
            {% elif file['type'] == 'directory' %}
                {{ folderSize(file['children'], dir_size.size) }}
            {% endif %}
        {% endfor %}
        <span>{{ dir_size.size |filesizeformat(true) }}</span>
    {% else %}
        <span class="empty-dir">Empty</span>
    {% endif %}
{% endmacro %}

{% macro renderFile(elem) %}
    <div class="container  {{ elem['status'] }}" id="dir-files" data-parent="{{ parent }}">
        <div class="row file-div">
          <div class="col-9 dir-name">
              <div class="row">
                  <div class="col-1 icon-div">
                      <i class="{{ elem['name']|file_icon }}" aria-hidden="true" style="font-size:16px;color:darkgreen"></i>
                  </div>
                  <div class="col-11">
                      {{ elem['name'] }}
                  </div>
              </div>
          </div>
          <div class="col-3 ml-auto">
            <div class="row">
                <div class="col-9 file-size">
                    {{ elem['size']|filesizeformat(true) }}
                </div>
                <div class="col-3">
                  {% if elem['status'] == 'available' %}
                      <div data-cont="file" data-path="{{ elem['path'] }}" class="delete-btn" id="delete-file">
                          <i class="fa fa-trash" aria-hidden="true"></i>
                      </div>
                  {% endif %}
                </div>
            </div>

          </div>
        </div>
    </div>
{% endmacro %}
{% macro renderElements(elem, count) %}
    {% set divclass = "padd-" ~ count %}
    {% if elem['type'] == 'directory' %}
        <div class="container info-row {{ elem['status'] }}" id="info-row-div">
            <div class="dir-div col-12 {{ divclass }}">
                <div class="row directory-row">
                    <div class="col-10 dir-name">
                        <i class="fa fa-folder" aria-hidden="true" style="font-size:24px;color:darkgreen"></i>
                        <span>{{ elem['name'] }}</span>
                        {{ dir_info(elem['data']) }}
                    </div>
                    {% if elem['status'] == 'available' %}
                        <div class="col-2 div-size ml-auto">
                            <div class="row directory-size">
                                <div class="col-9">{{ elem['dir_size']|filesizeformat(true) }}</div>
                                <div data-cont="dir" data-path="{{ elem['path'] }}" class="delete-btn col-3">
                                    <i class="fa fa-trash" aria-hidden="true"></i>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
                <div class="dir-content">
                    {% for file in elem['children']|sort(attribute='type', reverse = True) %}
                        {% set count = count + 20 %}
                        {{ renderElements(file, count) }}
                    {% endfor %}
                    {% set count = 0 %}
                </div>
            </div>
        </div>

    {% elif elem['type'] == 'file' %}
        {{ renderFile(elem) }}
    {% endif %}
{% endmacro %}
{% block container %}
    <div class="wrapper">
        <div class="info-view">
            {% for row in file_tree['children']|sort(attribute='type', reverse = True) %}
                {{ renderElements(row, 0) }}
            {% endfor %}
        </div>
    </div>
{% endblock %}